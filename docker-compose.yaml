# Xatu MCP Server - Docker Compose Configuration
#
# Usage:
#   docker-compose up -d              # Start all services
#   docker-compose up -d mcp-server   # Start just the MCP server
#   docker-compose logs -f mcp-server # View server logs
#
# Optional environment variables (with defaults):
#   MINIO_ACCESS_KEY    - MinIO access key (default: minioadmin)
#   MINIO_SECRET_KEY    - MinIO secret key (default: minioadmin)
#   MINIO_API_PORT      - MinIO S3 API port (default: 2400)
#   MINIO_CONSOLE_PORT  - MinIO console port (default: 2401)
#   MCP_SERVER_PORT     - MCP server port (default: 2480)
#   MCP_METRICS_PORT    - Metrics port (default: 2490)

services:
  # Build-only service to ensure sandbox image is available
  # This runs "true" and exits immediately - we just need the image built
  sandbox-builder:
    build:
      context: ./sandbox
    image: xatu-mcp-sandbox:latest
    command: "true"
    restart: "no"

  mcp-server:
    build:
      context: .
      dockerfile: Dockerfile
      args:
        - VERSION=${VERSION:-dev}
        - GIT_COMMIT=${GIT_COMMIT:-unknown}
        - BUILD_TIME=${BUILD_TIME:-unknown}
    ports:
      - "${MCP_SERVER_PORT:-2480}:2480"   # MCP server
      - "${MCP_METRICS_PORT:-2490}:2490"  # Metrics
    environment:
      - CONFIG_PATH=/config/config.yaml
      # ClickHouse - Xatu cluster
      - CLICKHOUSE_XATU_HOST=${CLICKHOUSE_XATU_HOST}
      - CLICKHOUSE_XATU_DATABASE=${CLICKHOUSE_XATU_DATABASE}
      - CLICKHOUSE_XATU_USERNAME=${CLICKHOUSE_XATU_USERNAME}
      - CLICKHOUSE_XATU_PASSWORD=${CLICKHOUSE_XATU_PASSWORD}
      # ClickHouse - CBT cluster
      - CLICKHOUSE_CBT_HOST=${CLICKHOUSE_CBT_HOST}
      - CLICKHOUSE_CBT_DATABASE=${CLICKHOUSE_CBT_DATABASE}
      - CLICKHOUSE_CBT_USERNAME=${CLICKHOUSE_CBT_USERNAME}
      - CLICKHOUSE_CBT_PASSWORD=${CLICKHOUSE_CBT_PASSWORD}
      # Prometheus - Platform
      - PROMETHEUS_PLATFORM_URL=${PROMETHEUS_PLATFORM_URL}
      - PROMETHEUS_PLATFORM_USERNAME=${PROMETHEUS_PLATFORM_USERNAME}
      - PROMETHEUS_PLATFORM_PASSWORD=${PROMETHEUS_PLATFORM_PASSWORD}
      # Prometheus - Devnets
      - PROMETHEUS_DEVNETS_URL=${PROMETHEUS_DEVNETS_URL}
      - PROMETHEUS_DEVNETS_USERNAME=${PROMETHEUS_DEVNETS_USERNAME}
      - PROMETHEUS_DEVNETS_PASSWORD=${PROMETHEUS_DEVNETS_PASSWORD}
      # Loki
      - LOKI_URL=${LOKI_URL}
      - LOKI_USERNAME=${LOKI_USERNAME}
      - LOKI_PASSWORD=${LOKI_PASSWORD}
      # S3 Storage
      - S3_ENDPOINT=http://minio:9000
      - S3_ACCESS_KEY=${MINIO_ACCESS_KEY:-minioadmin}
      - S3_SECRET_KEY=${MINIO_SECRET_KEY:-minioadmin}
      - S3_PUBLIC_URL=http://localhost:${MINIO_API_PORT:-2400}/xatu-mcp-outputs
      - S3_INTERNAL_URL=http://minio:9000/xatu-mcp-outputs
    volumes:
      - ./config.yaml:/config/config.yaml:ro
      - /var/run/docker.sock:/var/run/docker.sock
      - /tmp/xatu-mcp-sandbox:/tmp/xatu-mcp-sandbox  # Shared with sandbox containers
    networks:
      - mcp-external
      - mcp-internal
    depends_on:
      sandbox-builder:
        condition: service_completed_successfully
      minio:
        condition: service_healthy
    restart: unless-stopped

  # MinIO for S3-compatible storage
  minio:
    image: minio/minio:latest
    command: server /data --console-address ":9001"
    ports:
      - "${MINIO_API_PORT:-2400}:9000"       # S3 API
      - "${MINIO_CONSOLE_PORT:-2401}:9001"   # Console
    environment:
      MINIO_ROOT_USER: ${MINIO_ACCESS_KEY:-minioadmin}
      MINIO_ROOT_PASSWORD: ${MINIO_SECRET_KEY:-minioadmin}
    volumes:
      - minio-data:/data
    networks:
      - mcp-internal
      - mcp-external
    healthcheck:
      test: ["CMD", "mc", "ready", "local"]
      interval: 10s
      timeout: 5s
      retries: 5
    restart: unless-stopped

  # Create default bucket on startup
  minio-init:
    image: minio/mc:latest
    depends_on:
      minio:
        condition: service_healthy
    networks:
      - mcp-internal
    entrypoint: >
      /bin/sh -c "
      mc alias set local http://minio:9000 ${MINIO_ACCESS_KEY:-minioadmin} ${MINIO_SECRET_KEY:-minioadmin};
      mc mb local/xatu-mcp-outputs --ignore-existing;
      mc anonymous set download local/xatu-mcp-outputs;
      echo 'Bucket created and configured';
      "

networks:
  # External network - accessible from outside
  mcp-external:
    driver: bridge

  # Internal network - for sandbox containers
  mcp-internal:
    driver: bridge
    internal: true

volumes:
  minio-data:
