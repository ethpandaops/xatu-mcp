# Query Examples for Xatu ClickHouse Data
#
# Format:
#
# category_key:
#   name: Category Name
#   description: Description of this category
#   examples:
#     - name: Example Name
#       description: What this query does
#       cluster: xatu
#       query: |
#         SELECT ...
#         FROM table
#         WHERE slot_start_date_time >= now() - INTERVAL 1 HOUR
#           AND meta_network_name = 'mainnet'
#
# IMPORTANT: Always filter on partition key (slot_start_date_time) and meta_network_name

block_timing:
  name: Block Timing Analysis
  description: Queries for analyzing block arrival and propagation times using xatu-cbt aggregated data
  examples:
    - name: Average block arrival time
      description: Get the average block arrival time (seen_slot_start_diff) for recent slots.
      cluster: xatu-cbt
      query: |
        SELECT
          avg(seen_slot_start_diff) as avg_arrival_ms,
          median(seen_slot_start_diff) as median_arrival_ms,
          min(seen_slot_start_diff) as min_arrival_ms,
          max(seen_slot_start_diff) as max_arrival_ms
        FROM {network}.fct_block_first_seen_by_node
        WHERE slot_start_date_time >= now() - INTERVAL 1 HOUR

    - name: Block arrival time percentiles 
      description: Get percentile distribution of block arrival times.
      cluster: xatu-cbt
      query: |
        SELECT
          quantile(0.05)(seen_slot_start_diff) as p5_ms,
          quantile(0.25)(seen_slot_start_diff) as p25_ms,
          quantile(0.50)(seen_slot_start_diff) as p50_ms,
          quantile(0.75)(seen_slot_start_diff) as p75_ms,
          quantile(0.95)(seen_slot_start_diff) as p95_ms
        FROM {network}.fct_block_first_seen_by_node
        WHERE slot_start_date_time >= now() - INTERVAL 1 HOUR

    - name: Block arrival time for last N slots 
      description: Get block arrival stats aggregated per slot for the last 1000 slots.
      cluster: xatu-cbt
      query: |
        SELECT
          slot,
          min(seen_slot_start_diff) as arrival_time_ms,
          count() as observations
        FROM {network}.fct_block_first_seen_by_node
        WHERE slot_start_date_time >= now() - INTERVAL 4 HOUR
          AND slot >= (SELECT max(slot) - 999 FROM {network}.fct_block_first_seen_by_node WHERE slot_start_date_time >= now() - INTERVAL 4 HOUR)
        GROUP BY slot
        ORDER BY slot DESC

    - name: Block arrival by consensus client 
      description: Compare block arrival times across different consensus clients.
      cluster: xatu-cbt
      query: |
        SELECT
          meta_consensus_implementation as client,
          avg(seen_slot_start_diff) as avg_arrival_ms,
          quantile(0.95)(seen_slot_start_diff) as p95_arrival_ms,
          count() as observations
        FROM {network}.fct_block_first_seen_by_node
        WHERE slot_start_date_time >= now() - INTERVAL 1 HOUR
        GROUP BY client
        ORDER BY avg_arrival_ms

validators:
  name: Validator Analysis
  description: Queries for analyzing validator statistics
  examples:
    - name: Active validator count for most recent finalized epoch
      description: Get total count of active validators
      cluster: xatu
      query: |
        SELECT
          count() as active_validators
        FROM canonical_beacon_validators
        WHERE meta_network_name = 'mainnet'
          AND status = 'active_ongoing'
          AND epoch = (SELECT max(epoch) FROM canonical_beacon_validators WHERE meta_network_name = 'mainnet')

    - name: Validator status distribution for most recent finalized epoch
      description: Count validators by status
      cluster: xatu
      query: |
        SELECT
          status,
          count() as validator_count
        FROM canonical_beacon_validators
        WHERE meta_network_name = 'mainnet'
          AND epoch = (SELECT max(epoch) FROM canonical_beacon_validators WHERE meta_network_name = 'mainnet')
        GROUP BY status
        ORDER BY validator_count DESC

    - name: Validator balance statistics for most recent finalized epoch
      description: Get balance distribution of active validators
      cluster: xatu
      query: |
        SELECT
          avg(balance) / 1e9 as avg_balance_eth,
          min(balance) / 1e9 as min_balance_eth,
          max(balance) / 1e9 as max_balance_eth,
          sum(balance) / 1e9 as total_staked_eth
        FROM canonical_beacon_validators
        WHERE meta_network_name = 'mainnet'
          AND status = 'active_ongoing'
          AND epoch = (SELECT max(epoch) FROM canonical_beacon_validators WHERE meta_network_name = 'mainnet')

attestations:
  name: Attestation Analysis
  description: Queries for analyzing attestation behavior
  examples:
    - name: Attestation count
      description: Count attestations in the last hour
      cluster: xatu
      query: |
        SELECT
          count() as attestation_count,
          count(DISTINCT slot) as slots_with_attestations
        FROM beacon_api_eth_v1_events_attestation
        WHERE meta_network_name = 'mainnet'
          AND slot_start_date_time >= now() - INTERVAL 1 HOUR

    - name: Attestation propagation time
      description: Analyze attestation propagation delays
      cluster: xatu
      query: |
        SELECT
          avg(propagation_slot_start_diff) as avg_propagation_ms,
          quantile(0.50)(propagation_slot_start_diff) as p50_ms,
          quantile(0.95)(propagation_slot_start_diff) as p95_ms
        FROM beacon_api_eth_v1_events_attestation
        WHERE meta_network_name = 'mainnet'
          AND slot_start_date_time >= now() - INTERVAL 1 HOUR

network_health:
  name: Network Health Monitoring
  description: Queries used for monitoring Ethereum network health, derived from production alerting rules
  examples:
    - name: Attestation participation rate
      description: Calculate the ratio of attesting validators to total validators per slot. Used to detect participation drops below 66% which could indicate network issues.
      cluster: xatu
      query: |
        WITH total_validators AS (
          SELECT
            slot_start_date_time,
            sum(length(validators)) AS total_validators
          FROM (
            SELECT
              slot_start_date_time,
              committee_index,
              validators
            FROM default.beacon_api_eth_v1_beacon_committee
            WHERE slot_start_date_time >= now() - INTERVAL 5 MINUTE
              AND meta_network_name = 'mainnet'
            LIMIT 1 BY slot_start_date_time, committee_index
          )
          GROUP BY slot_start_date_time
        ),
        attesting_validators AS (
          SELECT
            slot_start_date_time,
            COUNT(DISTINCT attesting_validator_index) AS attesting_validators
          FROM default.beacon_api_eth_v1_events_attestation
          WHERE slot_start_date_time >= now() - INTERVAL 5 MINUTE
            AND meta_network_name = 'mainnet'
          GROUP BY slot_start_date_time
        )
        SELECT
          t.slot_start_date_time,
          t.total_validators,
          a.attesting_validators,
          a.attesting_validators / t.total_validators AS participation_rate
        FROM total_validators t
        JOIN attesting_validators a ON t.slot_start_date_time = a.slot_start_date_time
        ORDER BY t.slot_start_date_time

    - name: Finalized epoch distance
      description: Check how long ago the last finalization occurred. Values consistently above 21 minutes suggest finalization issues.
      cluster: xatu
      query: |
        SELECT
          epoch,
          MIN(epoch_start_date_time) AS first_finalized_event_time,
          dateDiff('minute', MIN(epoch_start_date_time), now()) AS finalized_age_minutes
        FROM beacon_api_eth_v1_events_finalized_checkpoint
        WHERE meta_network_name = 'mainnet'
          AND epoch_start_date_time >= now() - INTERVAL 1 DAY
        GROUP BY epoch
        ORDER BY finalized_age_minutes ASC
        LIMIT 10

    - name: Data pipeline health check
      description: Verify the data pipeline is healthy by checking for sufficient client diversity and event volume. Used as a guard condition before other alerts fire.
      cluster: xatu
      query: |
        SELECT
          COUNT(DISTINCT meta_client_name) AS distinct_clients,
          COUNT(*) AS total_events,
          if(COUNT(DISTINCT meta_client_name) > 3 AND COUNT(*) > 500, 'healthy', 'unhealthy') AS pipeline_status
        FROM beacon_api_eth_v1_events_attestation
        WHERE slot_start_date_time >= now() - INTERVAL 5 MINUTE
          AND meta_network_name = 'mainnet'

    - name: Attestation participation rate 
      description: Calculate attestation participation using pre-aggregated correctness data. votes_head shows attestations for the current slot's block vs votes_max (total scheduled).
      cluster: xatu-cbt
      query: |
        SELECT
          slot_start_date_time,
          slot,
          votes_max AS total_scheduled_votes,
          votes_head AS votes_for_head_block,
          votes_other AS votes_for_other_blocks,
          (votes_head + votes_other) AS total_votes,
          ((votes_head + votes_other) / votes_max) AS participation_rate
        FROM {network}.fct_attestation_correctness_head FINAL
        WHERE slot_start_date_time >= now() - INTERVAL 1 HOUR
        ORDER BY slot_start_date_time DESC

    - name: Attestation correctness rate 
      description: Calculate the percentage of attestations voting for the correct (head) block vs other blocks. Low correctness may indicate forks or reorgs.
      cluster: xatu-cbt
      query: |
        SELECT
          slot_start_date_time,
          slot,
          votes_head,
          votes_other,
          (votes_head + votes_other) AS total_votes,
          if((votes_head + votes_other) > 0,
             votes_head / (votes_head + votes_other) * 100,
             0) AS correctness_percentage
        FROM {network}.fct_attestation_correctness_head FINAL
        WHERE slot_start_date_time >= now() - INTERVAL 1 HOUR
          AND votes_max > 0
        ORDER BY slot_start_date_time DESC

    - name: Block arrival time by node 
      description: Get block arrival times (seen_slot_start_diff) per node. Useful for identifying slow nodes or network issues.
      cluster: xatu-cbt
      query: |
        SELECT
          slot_start_date_time,
          slot,
          meta_client_name,
          meta_consensus_implementation,
          meta_client_geo_country,
          seen_slot_start_diff AS arrival_time_ms
        FROM {network}.fct_block_first_seen_by_node FINAL
        WHERE slot_start_date_time >= now() - INTERVAL 5 MINUTE
        ORDER BY slot_start_date_time DESC, arrival_time_ms ASC

    - name: Minimum block arrival time per slot 
      description: Get the minimum (fastest) block arrival time per slot across all nodes.
      cluster: xatu-cbt
      query: |
        SELECT
          slot_start_date_time,
          slot,
          MIN(seen_slot_start_diff) AS min_arrival_ms,
          quantile(0.50)(seen_slot_start_diff) AS p50_arrival_ms,
          quantile(0.95)(seen_slot_start_diff) AS p95_arrival_ms,
          COUNT(DISTINCT node_id) AS reporting_nodes
        FROM {network}.fct_block_first_seen_by_node FINAL
        WHERE slot_start_date_time >= now() - INTERVAL 1 HOUR
        GROUP BY slot_start_date_time, slot
        ORDER BY slot_start_date_time DESC

    - name: Block arrival by consensus client 
      description: Compare block arrival times across different consensus client implementations.
      cluster: xatu-cbt
      query: |
        SELECT
          meta_consensus_implementation AS client,
          AVG(seen_slot_start_diff) AS avg_arrival_ms,
          quantile(0.50)(seen_slot_start_diff) AS p50_arrival_ms,
          quantile(0.95)(seen_slot_start_diff) AS p95_arrival_ms,
          COUNT() AS observations,
          COUNT(DISTINCT node_id) AS unique_nodes
        FROM {network}.fct_block_first_seen_by_node FINAL
        WHERE slot_start_date_time >= now() - INTERVAL 1 HOUR
        GROUP BY client
        ORDER BY avg_arrival_ms ASC

    - name: Block arrival by country 
      description: Compare block arrival times across different geographic locations.
      cluster: xatu-cbt
      query: |
        SELECT
          meta_client_geo_country AS country,
          AVG(seen_slot_start_diff) AS avg_arrival_ms,
          quantile(0.50)(seen_slot_start_diff) AS p50_arrival_ms,
          quantile(0.95)(seen_slot_start_diff) AS p95_arrival_ms,
          COUNT() AS observations,
          COUNT(DISTINCT node_id) AS unique_nodes
        FROM {network}.fct_block_first_seen_by_node FINAL
        WHERE slot_start_date_time >= now() - INTERVAL 1 HOUR
          AND meta_client_geo_country != ''
        GROUP BY country
        ORDER BY avg_arrival_ms ASC

    - name: Locally built blocks by client 
      description: Track locally prepared/built blocks per consensus client using the pre-aggregated fct_prepared_block table.
      cluster: xatu-cbt
      query: |
        SELECT
          meta_consensus_implementation AS consensus_client,
          MAX(slot_start_date_time) AS last_block_time,
          dateDiff('second', MAX(slot_start_date_time), now()) AS seconds_since_last_block,
          COUNT() AS blocks_in_window,
          AVG(execution_payload_gas_used) AS avg_gas_used,
          AVG(execution_payload_transactions_count) AS avg_tx_count
        FROM {network}.fct_prepared_block FINAL
        WHERE slot_start_date_time >= now() - INTERVAL 30 MINUTE
        GROUP BY consensus_client
        ORDER BY consensus_client

    - name: Validator committee size per slot 
      description: Get the total validators scheduled per slot from committee data.
      cluster: xatu-cbt
      query: |
        SELECT
          slot_start_date_time,
          slot,
          SUM(length(validators)) AS total_validators,
          COUNT() AS committee_count
        FROM {network}.int_beacon_committee_head FINAL
        WHERE slot_start_date_time >= now() - INTERVAL 1 HOUR
        GROUP BY slot_start_date_time, slot
        ORDER BY slot_start_date_time DESC

    - name: Epoch participation summary 
      description: Summarize attestation participation per epoch using pre-aggregated data.
      cluster: xatu-cbt
      query: |
        SELECT
          epoch,
          epoch_start_date_time,
          SUM(votes_max) AS total_scheduled,
          SUM(votes_head) AS total_head_votes,
          SUM(votes_other) AS total_other_votes,
          SUM(votes_head + votes_other) AS total_actual_votes,
          SUM(votes_head + votes_other) / SUM(votes_max) AS participation_rate,
          SUM(votes_head) / SUM(votes_head + votes_other) AS correctness_rate
        FROM {network}.fct_attestation_correctness_head FINAL
        WHERE epoch_start_date_time >= now() - INTERVAL 1 DAY
        GROUP BY epoch, epoch_start_date_time
        ORDER BY epoch DESC

entity_analysis:
  name: Entity Analysis
  description: Queries for analyzing staking entities (operators, pools, exchanges) and their performance
  examples:
    - name: Entity attestation liveness ranking
      description: Rank staking entities by attestation liveness (attestations vs missed).
      cluster: xatu-cbt
      query: |
        SELECT
          entity,
          SUM(attestation_count) AS total_attestations,
          SUM(missed_count) AS total_missed,
          SUM(attestation_count) + SUM(missed_count) AS total_duties,
          SUM(attestation_count) / (SUM(attestation_count) + SUM(missed_count)) AS liveness_rate
        FROM {network}.fct_attestation_liveness_by_entity_head FINAL
        WHERE slot_start_date_time >= now() - INTERVAL 1 DAY
        GROUP BY entity
        ORDER BY total_attestations DESC

    - name: Entity attestation liveness over time
      description: Track attestation liveness per entity over time (hourly).
      cluster: xatu-cbt
      query: |
        SELECT
          toStartOfHour(slot_start_date_time) AS hour,
          entity,
          SUM(attestation_count) AS attestations,
          SUM(missed_count) AS missed,
          SUM(attestation_count) / (SUM(attestation_count) + SUM(missed_count)) AS liveness_rate
        FROM {network}.fct_attestation_liveness_by_entity_head FINAL
        WHERE slot_start_date_time >= now() - INTERVAL 1 DAY
          AND entity != 'unknown'
        GROUP BY hour, entity
        ORDER BY hour DESC, attestations DESC

    - name: Entity block proposals
      description: Count block proposals per staking entity.
      cluster: xatu-cbt
      query: |
        SELECT
          entity,
          COUNT() AS blocks_proposed,
          COUNT(DISTINCT epoch) AS epochs_active,
          MIN(slot_start_date_time) AS first_block,
          MAX(slot_start_date_time) AS last_block
        FROM {network}.fct_block_proposer_entity FINAL
        WHERE slot_start_date_time >= now() - INTERVAL 1 DAY
        GROUP BY entity
        ORDER BY blocks_proposed DESC

    - name: Entity missed slots
      description: Identify entities with missed block proposals by comparing scheduled vs proposed.
      cluster: xatu-cbt
      query: |
        WITH scheduled AS (
          SELECT
            entity,
            COUNT() AS scheduled_blocks
          FROM {network}.fct_block_proposer_entity FINAL
          WHERE slot_start_date_time >= now() - INTERVAL 1 DAY
          GROUP BY entity
        ),
        proposed AS (
          SELECT
            e.entity,
            COUNT() AS proposed_blocks
          FROM {network}.fct_block_proposer_entity e FINAL
          INNER JOIN {network}.fct_block_head b FINAL ON e.slot = b.slot
          WHERE e.slot_start_date_time >= now() - INTERVAL 1 DAY
          GROUP BY e.entity
        )
        SELECT
          s.entity,
          s.scheduled_blocks,
          COALESCE(p.proposed_blocks, 0) AS proposed_blocks,
          s.scheduled_blocks - COALESCE(p.proposed_blocks, 0) AS missed_blocks,
          COALESCE(p.proposed_blocks, 0) / s.scheduled_blocks AS proposal_rate
        FROM scheduled s
        LEFT JOIN proposed p ON s.entity = p.entity
        ORDER BY missed_blocks DESC

    - name: Top staking entities by validator count
      description: Estimate validator count per entity from attestation duties.
      cluster: xatu-cbt
      query: |
        SELECT
          entity,
          SUM(attestation_count + missed_count) AS total_duties,
          -- Each validator has 1 attestation duty per epoch (~225 epochs/day)
          SUM(attestation_count + missed_count) / 225 AS estimated_validators,
          SUM(attestation_count) / (SUM(attestation_count) + SUM(missed_count)) AS liveness_rate
        FROM {network}.fct_attestation_liveness_by_entity_head FINAL
        WHERE slot_start_date_time >= now() - INTERVAL 1 DAY
        GROUP BY entity
        ORDER BY total_duties DESC
        LIMIT 30

mev_analysis:
  name: MEV Analysis
  description: Queries for analyzing MEV (Maximal Extractable Value) activity including relays, builders, and block values
  examples:
    - name: MEV relay activity
      description: Analyze MEV relay bid activity per slot.
      cluster: xatu-cbt
      query: |
        SELECT
          relay_name,
          SUM(bid_total) AS total_bids,
          AVG(bid_total) AS avg_bids_per_slot,
          COUNT(DISTINCT slot) AS slots_with_bids
        FROM {network}.fct_mev_bid_count_by_relay FINAL
        WHERE slot_start_date_time >= now() - INTERVAL 1 DAY
        GROUP BY relay_name
        ORDER BY total_bids DESC

    - name: MEV builder activity
      description: Analyze MEV builder bid activity.
      cluster: xatu-cbt
      query: |
        SELECT
          builder_pubkey,
          SUM(bid_total) AS total_bids,
          AVG(bid_total) AS avg_bids_per_slot,
          COUNT(DISTINCT slot) AS slots_active
        FROM {network}.fct_mev_bid_count_by_builder FINAL
        WHERE slot_start_date_time >= now() - INTERVAL 1 DAY
        GROUP BY builder_pubkey
        ORDER BY total_bids DESC
        LIMIT 20

    - name: MEV block value distribution
      description: Analyze the distribution of MEV block values.
      cluster: xatu-cbt
      query: |
        SELECT
          toStartOfHour(slot_start_date_time) AS hour,
          COUNT() AS mev_blocks,
          AVG(value) / 1e18 AS avg_value_eth,
          quantile(0.50)(value) / 1e18 AS median_value_eth,
          quantile(0.95)(value) / 1e18 AS p95_value_eth,
          MAX(value) / 1e18 AS max_value_eth,
          SUM(value) / 1e18 AS total_value_eth
        FROM {network}.fct_block_mev_head FINAL
        WHERE slot_start_date_time >= now() - INTERVAL 1 DAY
          AND value IS NOT NULL
        GROUP BY hour
        ORDER BY hour DESC

    - name: Top MEV blocks by value
      description: Find the highest value MEV blocks.
      cluster: xatu-cbt
      query: |
        SELECT
          slot,
          slot_start_date_time,
          block_number,
          value / 1e18 AS value_eth,
          builder_pubkey,
          relay_names,
          transaction_count,
          gas_used
        FROM {network}.fct_block_mev_head FINAL
        WHERE slot_start_date_time >= now() - INTERVAL 1 DAY
          AND value IS NOT NULL
        ORDER BY value DESC
        LIMIT 20

    - name: MEV relay market share
      description: Calculate MEV relay market share by delivered blocks.
      cluster: xatu-cbt
      query: |
        SELECT
          arrayJoin(relay_names) AS relay,
          COUNT() AS blocks_delivered,
          SUM(value) / 1e18 AS total_value_eth,
          AVG(value) / 1e18 AS avg_value_eth
        FROM {network}.fct_block_mev_head FINAL
        WHERE slot_start_date_time >= now() - INTERVAL 1 DAY
          AND value IS NOT NULL
        GROUP BY relay
        ORDER BY blocks_delivered DESC

    - name: Builder market share
      description: Calculate builder market share by block count and value.
      cluster: xatu-cbt
      query: |
        SELECT
          builder_pubkey,
          COUNT() AS blocks_built,
          SUM(value) / 1e18 AS total_value_eth,
          AVG(value) / 1e18 AS avg_value_eth,
          AVG(transaction_count) AS avg_tx_count,
          AVG(gas_used) AS avg_gas_used
        FROM {network}.fct_block_mev_head FINAL
        WHERE slot_start_date_time >= now() - INTERVAL 1 DAY
          AND value IS NOT NULL
        GROUP BY builder_pubkey
        ORDER BY blocks_built DESC
        LIMIT 20

    - name: MEV vs local block comparison
      description: Compare MEV blocks vs locally built blocks in terms of value and gas usage.
      cluster: xatu-cbt
      query: |
        WITH mev_stats AS (
          SELECT
            'mev' AS block_type,
            COUNT() AS block_count,
            AVG(value) / 1e18 AS avg_value_eth,
            AVG(gas_used) AS avg_gas_used,
            AVG(transaction_count) AS avg_tx_count
          FROM {network}.fct_block_mev_head FINAL
          WHERE slot_start_date_time >= now() - INTERVAL 1 DAY
            AND value IS NOT NULL
        ),
        local_stats AS (
          SELECT
            'local' AS block_type,
            COUNT() AS block_count,
            AVG(execution_payload_value) / 1e18 AS avg_value_eth,
            AVG(execution_payload_gas_used) AS avg_gas_used,
            AVG(execution_payload_transactions_count) AS avg_tx_count
          FROM {network}.fct_prepared_block FINAL
          WHERE slot_start_date_time >= now() - INTERVAL 1 DAY
        )
        SELECT * FROM mev_stats
        UNION ALL
        SELECT * FROM local_stats

    - name: Hourly MEV activity trend
      description: Track MEV activity trends by hour including bid counts and block values.
      cluster: xatu-cbt
      query: |
        SELECT
          toStartOfHour(slot_start_date_time) AS hour,
          COUNT() AS mev_blocks,
          SUM(value) / 1e18 AS total_value_eth,
          AVG(value) / 1e18 AS avg_value_eth,
          COUNT(DISTINCT builder_pubkey) AS unique_builders
        FROM {network}.fct_block_mev_head FINAL
        WHERE slot_start_date_time >= now() - INTERVAL 1 DAY
          AND value IS NOT NULL
        GROUP BY hour
        ORDER BY hour DESC

head_accuracy:
  name: Head Vote Accuracy
  description: Queries for analyzing attestation head vote accuracy, inclusion delays, and propagation timing
  examples:
    - name: Head vote accuracy by slot
      description: Calculate the percentage of attestations that voted for the correct head (slot_distance=0) per slot.
      cluster: xatu-cbt
      query: |
        SELECT
          slot_start_date_time,
          slot,
          COUNT() AS total_attestations,
          countIf(slot_distance = 0) AS correct_head_votes,
          countIf(slot_distance = 1) AS one_slot_behind,
          countIf(slot_distance > 1) AS more_than_one_behind,
          countIf(slot_distance IS NULL) AS missed,
          countIf(slot_distance = 0) * 100.0 / COUNT() AS head_accuracy_pct
        FROM {network}.fct_attestation_correctness_by_validator_head FINAL
        WHERE slot_start_date_time >= now() - INTERVAL 1 HOUR
        GROUP BY slot_start_date_time, slot
        ORDER BY slot_start_date_time DESC

    - name: Head vote accuracy summary
      description: Overall head vote accuracy metrics for a time period.
      cluster: xatu-cbt
      query: |
        SELECT
          COUNT() AS total_attestations,
          countIf(slot_distance = 0) AS correct_head_votes,
          countIf(slot_distance = 0) * 100.0 / COUNT() AS head_accuracy_pct,
          countIf(slot_distance = 1) * 100.0 / COUNT() AS one_slot_behind_pct,
          countIf(slot_distance > 1) * 100.0 / COUNT() AS multiple_slots_behind_pct,
          countIf(slot_distance IS NULL) * 100.0 / COUNT() AS missed_pct
        FROM {network}.fct_attestation_correctness_by_validator_head FINAL
        WHERE slot_start_date_time >= now() - INTERVAL 1 HOUR

    - name: Slot distance distribution
      description: Distribution of how far behind validators attested (0 = perfect head vote).
      cluster: xatu-cbt
      query: |
        SELECT
          slot_distance,
          COUNT() AS attestation_count,
          COUNT() * 100.0 / SUM(COUNT()) OVER () AS percentage
        FROM {network}.fct_attestation_correctness_by_validator_head FINAL
        WHERE slot_start_date_time >= now() - INTERVAL 1 HOUR
        GROUP BY slot_distance
        ORDER BY slot_distance

    - name: Propagation timing distribution
      description: When attestations were propagated relative to their duty slot (0 = same slot, ideal).
      cluster: xatu-cbt
      query: |
        SELECT
          propagation_distance,
          COUNT() AS attestation_count,
          COUNT() * 100.0 / SUM(COUNT()) OVER () AS percentage
        FROM {network}.fct_attestation_correctness_by_validator_head FINAL
        WHERE slot_start_date_time >= now() - INTERVAL 1 HOUR
        GROUP BY propagation_distance
        ORDER BY propagation_distance

    - name: Attestation inclusion delay distribution
      description: How many slots after the attestation duty it was included in a block (1 = optimal).
      cluster: xatu-cbt
      query: |
        SELECT
          inclusion_distance,
          COUNT() AS attestation_count,
          COUNT() * 100.0 / SUM(COUNT()) OVER () AS percentage
        FROM {network}.fct_attestation_correctness_by_validator_canonical FINAL
        WHERE slot_start_date_time >= now() - INTERVAL 1 HOUR
          AND status = 'canonical'
        GROUP BY inclusion_distance
        ORDER BY inclusion_distance

    - name: Attestation status breakdown
      description: Breakdown of attestation outcomes - canonical (included), missed, orphaned.
      cluster: xatu-cbt
      query: |
        SELECT
          status,
          COUNT() AS attestation_count,
          COUNT() * 100.0 / SUM(COUNT()) OVER () AS percentage
        FROM {network}.fct_attestation_correctness_by_validator_canonical FINAL
        WHERE slot_start_date_time >= now() - INTERVAL 1 HOUR
        GROUP BY status
        ORDER BY attestation_count DESC

    - name: Head accuracy over time (hourly)
      description: Track head vote accuracy trends by hour.
      cluster: xatu-cbt
      query: |
        SELECT
          toStartOfHour(slot_start_date_time) AS hour,
          COUNT() AS total_attestations,
          countIf(slot_distance = 0) * 100.0 / COUNT() AS head_accuracy_pct,
          countIf(slot_distance IS NULL) * 100.0 / COUNT() AS missed_pct,
          AVG(slot_distance) AS avg_slot_distance
        FROM {network}.fct_attestation_correctness_by_validator_head FINAL
        WHERE slot_start_date_time >= now() - INTERVAL 1 DAY
        GROUP BY hour
        ORDER BY hour DESC

    - name: Validators with poor head accuracy
      description: Find validators with below-average head vote accuracy (potential issues).
      cluster: xatu-cbt
      query: |
        SELECT
          attesting_validator_index,
          COUNT() AS total_duties,
          countIf(slot_distance = 0) AS correct_head_votes,
          countIf(slot_distance IS NULL) AS missed,
          countIf(slot_distance = 0) * 100.0 / COUNT() AS head_accuracy_pct
        FROM {network}.fct_attestation_correctness_by_validator_head FINAL
        WHERE slot_start_date_time >= now() - INTERVAL 1 DAY
        GROUP BY attesting_validator_index
        HAVING head_accuracy_pct < 95
        ORDER BY head_accuracy_pct ASC
        LIMIT 100

    - name: Validators with high inclusion delay
      description: Find validators whose attestations are consistently included late.
      cluster: xatu-cbt
      query: |
        SELECT
          attesting_validator_index,
          COUNT() AS total_attestations,
          AVG(inclusion_distance) AS avg_inclusion_delay,
          countIf(inclusion_distance = 1) * 100.0 / COUNT() AS optimal_inclusion_pct,
          countIf(inclusion_distance > 1) * 100.0 / COUNT() AS delayed_pct
        FROM {network}.fct_attestation_correctness_by_validator_canonical FINAL
        WHERE slot_start_date_time >= now() - INTERVAL 1 DAY
          AND status = 'canonical'
        GROUP BY attesting_validator_index
        HAVING avg_inclusion_delay > 1.5
        ORDER BY avg_inclusion_delay DESC
        LIMIT 100

    - name: Epoch head accuracy summary
      description: Head vote accuracy aggregated by epoch.
      cluster: xatu-cbt
      query: |
        SELECT
          epoch,
          epoch_start_date_time,
          COUNT() AS total_attestations,
          countIf(slot_distance = 0) * 100.0 / COUNT() AS head_accuracy_pct,
          countIf(slot_distance IS NULL) * 100.0 / COUNT() AS missed_pct,
          AVG(slot_distance) AS avg_slot_distance
        FROM {network}.fct_attestation_correctness_by_validator_head FINAL
        WHERE epoch_start_date_time >= now() - INTERVAL 1 DAY
        GROUP BY epoch, epoch_start_date_time
        ORDER BY epoch DESC

    - name: Slots with low head accuracy
      description: Identify slots where head vote accuracy dropped significantly (potential reorgs or issues).
      cluster: xatu-cbt
      query: |
        SELECT
          slot_start_date_time,
          slot,
          COUNT() AS total_attestations,
          countIf(slot_distance = 0) AS correct_head_votes,
          countIf(slot_distance > 0) AS incorrect_head_votes,
          countIf(slot_distance = 0) * 100.0 / COUNT() AS head_accuracy_pct
        FROM {network}.fct_attestation_correctness_by_validator_head FINAL
        WHERE slot_start_date_time >= now() - INTERVAL 1 DAY
        GROUP BY slot_start_date_time, slot
        HAVING head_accuracy_pct < 95
        ORDER BY head_accuracy_pct ASC
        LIMIT 50

    - name: Combined head and inclusion metrics
      description: Comprehensive view combining head accuracy and inclusion timing per slot.
      cluster: xatu-cbt
      query: |
        WITH head_stats AS (
          SELECT
            slot,
            slot_start_date_time,
            countIf(slot_distance = 0) * 100.0 / COUNT() AS head_accuracy_pct,
            AVG(slot_distance) AS avg_slot_distance
          FROM {network}.fct_attestation_correctness_by_validator_head FINAL
          WHERE slot_start_date_time >= now() - INTERVAL 1 HOUR
          GROUP BY slot, slot_start_date_time
        ),
        canonical_stats AS (
          SELECT
            slot,
            countIf(status = 'canonical') * 100.0 / COUNT() AS inclusion_rate_pct,
            AVG(inclusion_distance) AS avg_inclusion_delay
          FROM {network}.fct_attestation_correctness_by_validator_canonical FINAL
          WHERE slot_start_date_time >= now() - INTERVAL 1 HOUR
          GROUP BY slot
        )
        SELECT
          h.slot,
          h.slot_start_date_time,
          h.head_accuracy_pct,
          h.avg_slot_distance,
          c.inclusion_rate_pct,
          c.avg_inclusion_delay
        FROM head_stats h
        LEFT JOIN canonical_stats c ON h.slot = c.slot
        ORDER BY h.slot_start_date_time DESC

blob_analysis:
  name: Blob Analysis
  description: Queries for analyzing EIP-4844 blob data including blob counts, submitters, and L2 rollup activity
  examples:
    - name: Blob count per slot
      description: Get the number of blobs in each slot.
      cluster: xatu-cbt
      query: |
        SELECT
          slot_start_date_time,
          slot,
          blob_count
        FROM {network}.fct_block_blob_count_head FINAL
        WHERE slot_start_date_time >= now() - INTERVAL 1 HOUR
        ORDER BY slot_start_date_time DESC

    - name: Blob count distribution
      description: Distribution of blob counts across slots
      cluster: xatu-cbt
      query: |
        SELECT
          blob_count,
          COUNT() AS slot_count,
          COUNT() * 100.0 / SUM(COUNT()) OVER () AS percentage
        FROM {network}.fct_block_blob_count_head FINAL
        WHERE slot_start_date_time >= now() - INTERVAL 1 DAY
        GROUP BY blob_count
        ORDER BY blob_count

    - name: Average blobs per slot over time
      description: Track blob usage trends by hour.
      cluster: xatu-cbt
      query: |
        SELECT
          toStartOfHour(slot_start_date_time) AS hour,
          AVG(blob_count) AS avg_blobs_per_slot,
          SUM(blob_count) AS total_blobs,
          COUNT() AS slots,
          MAX(blob_count) AS max_blobs_in_slot
        FROM {network}.fct_block_blob_count_head FINAL
        WHERE slot_start_date_time >= now() - INTERVAL 1 DAY
        GROUP BY hour
        ORDER BY hour DESC

    - name: Blob submitters ranking
      description: Top blob submitters (L2 rollups and other users) by blob count.
      cluster: xatu-cbt
      query: |
        SELECT
          name,
          address,
          COUNT() AS submission_count,
          SUM(length(versioned_hashes)) AS total_blobs
        FROM {network}.dim_block_blob_submitter FINAL
        WHERE updated_date_time >= now() - INTERVAL 1 DAY
        GROUP BY name, address
        ORDER BY total_blobs DESC
        LIMIT 20

    - name: Blob submitters over time
      description: Track blob submission activity by submitter over time (hourly).
      cluster: xatu-cbt
      query: |
        SELECT
          toStartOfHour(updated_date_time) AS hour,
          name,
          COUNT() AS submissions,
          SUM(length(versioned_hashes)) AS blobs
        FROM {network}.dim_block_blob_submitter FINAL
        WHERE updated_date_time >= now() - INTERVAL 1 DAY
          AND name IS NOT NULL
        GROUP BY hour, name
        ORDER BY hour DESC, blobs DESC

    - name: L2 rollup blob market share
      description: Calculate blob market share by L2 rollup/submitter.
      cluster: xatu-cbt
      query: |
        SELECT
          COALESCE(name, 'Unknown') AS submitter,
          SUM(length(versioned_hashes)) AS total_blobs,
          SUM(length(versioned_hashes)) * 100.0 /
            (SELECT SUM(length(versioned_hashes)) FROM {network}.dim_block_blob_submitter FINAL WHERE updated_date_time >= now() - INTERVAL 1 DAY) AS market_share_pct
        FROM {network}.dim_block_blob_submitter FINAL
        WHERE updated_date_time >= now() - INTERVAL 1 DAY
        GROUP BY submitter
        ORDER BY total_blobs DESC



    - name: Daily blob statistics
      description: Daily summary of blob activity.
      cluster: xatu-cbt
      query: |
        SELECT
          toDate(slot_start_date_time) AS day,
          COUNT() AS total_slots,
          SUM(blob_count) AS total_blobs,
          AVG(blob_count) AS avg_blobs_per_slot,
          countIf(blob_count > 0) AS slots_with_blobs,
          countIf(blob_count = 0) AS slots_without_blobs,
          MAX(blob_count) AS max_blobs_in_slot
        FROM {network}.fct_block_blob_count_head FINAL
        WHERE slot_start_date_time >= now() - INTERVAL 7 DAY
        GROUP BY day
        ORDER BY day DESC

    - name: Blob submitter transaction details
      description: Get detailed transaction info for blob submissions.
      cluster: xatu-cbt
      query: |
        SELECT
          updated_date_time,
          block_number,
          transaction_hash,
          transaction_index,
          name AS submitter_name,
          address AS submitter_address,
          length(versioned_hashes) AS blob_count,
          versioned_hashes
        FROM {network}.dim_block_blob_submitter FINAL
        WHERE updated_date_time >= now() - INTERVAL 1 HOUR
        ORDER BY updated_date_time DESC
        LIMIT 50

data_column_sidecars:
  name: Data Column Sidecars (PeerDAS)
  description: Queries for analyzing EIP-7594 PeerDAS data column availability and propagation
  examples:
    - name: Data column availability by slot
      description: Get data column availability percentage per slot and column index.
      cluster: xatu-cbt
      query: |
        SELECT
          slot,
          column_index,
          availability_pct,
          probe_count,
          success_count,
          failure_count,
          p50_response_time_ms,
          p95_response_time_ms
        FROM {network}.fct_data_column_availability_by_slot FINAL
        WHERE slot_start_date_time >= now() - INTERVAL 1 HOUR
        ORDER BY slot DESC, column_index
        LIMIT 100

    - name: Average column availability by index
      description: Average availability percentage for each column index over recent slots.
      cluster: xatu-cbt
      query: |
        SELECT
          column_index,
          AVG(availability_pct) AS avg_availability_pct,
          MIN(availability_pct) AS min_availability_pct,
          COUNT() AS slot_count,
          SUM(probe_count) AS total_probes
        FROM {network}.fct_data_column_availability_by_slot FINAL
        WHERE slot_start_date_time >= now() - INTERVAL 1 HOUR
        GROUP BY column_index
        ORDER BY column_index

    - name: Data column availability by epoch
      description: Epoch-level aggregated data column availability statistics.
      cluster: xatu-cbt
      query: |
        SELECT
          epoch,
          column_index,
          avg_availability_pct,
          min_availability_pct,
          max_availability_pct,
          total_probe_count,
          total_success_count,
          avg_p50_response_time_ms,
          avg_p95_response_time_ms
        FROM {network}.fct_data_column_availability_by_epoch FINAL
        WHERE epoch_start_date_time >= now() - INTERVAL 6 HOUR
        ORDER BY epoch DESC, column_index
        LIMIT 100

    - name: Hourly data column availability trend
      description: Hourly trend of data column availability across all columns.
      cluster: xatu-cbt
      query: |
        SELECT
          hour_start_date_time,
          column_index,
          avg_availability_pct,
          total_probe_count,
          total_success_count,
          total_failure_count,
          avg_p50_response_time_ms
        FROM {network}.fct_data_column_availability_hourly FINAL
        WHERE hour_start_date_time >= now() - INTERVAL 24 HOUR
        ORDER BY hour_start_date_time DESC, column_index

    - name: Columns with lowest availability
      description: Find data columns with the lowest availability in recent slots.
      cluster: xatu-cbt
      query: |
        SELECT
          column_index,
          AVG(availability_pct) AS avg_availability_pct,
          MIN(availability_pct) AS min_availability_pct,
          countIf(availability_pct < 100) AS slots_below_100_pct,
          SUM(failure_count) AS total_failures
        FROM {network}.fct_data_column_availability_by_slot FINAL
        WHERE slot_start_date_time >= now() - INTERVAL 1 HOUR
        GROUP BY column_index
        ORDER BY avg_availability_pct ASC
        LIMIT 20

    - name: Data column first seen timing
      description: When data columns were first seen across the network.
      cluster: xatu-cbt
      query: |
        SELECT
          slot,
          column_index,
          MIN(seen_slot_start_diff) AS first_seen_ms,
          AVG(seen_slot_start_diff) AS avg_seen_ms,
          MAX(seen_slot_start_diff) AS max_seen_ms,
          COUNT() AS observation_count
        FROM {network}.fct_block_data_column_sidecar_first_seen FINAL
        WHERE slot_start_date_time >= now() - INTERVAL 1 HOUR
        GROUP BY slot, column_index
        ORDER BY slot DESC, column_index
        LIMIT 100

    - name: Data column propagation by consensus client
      description: Compare data column propagation times across consensus clients.
      cluster: xatu-cbt
      query: |
        SELECT
          meta_consensus_implementation AS client,
          AVG(seen_slot_start_diff) AS avg_propagation_ms,
          quantile(0.50)(seen_slot_start_diff) AS p50_propagation_ms,
          quantile(0.95)(seen_slot_start_diff) AS p95_propagation_ms,
          COUNT() AS observations
        FROM {network}.fct_block_data_column_sidecar_first_seen_by_node FINAL
        WHERE slot_start_date_time >= now() - INTERVAL 1 HOUR
        GROUP BY client
        ORDER BY avg_propagation_ms

    - name: Data column propagation by country
      description: Compare data column propagation times across geographic regions.
      cluster: xatu-cbt
      query: |
        SELECT
          meta_client_geo_country AS country,
          AVG(seen_slot_start_diff) AS avg_propagation_ms,
          quantile(0.50)(seen_slot_start_diff) AS p50_propagation_ms,
          quantile(0.95)(seen_slot_start_diff) AS p95_propagation_ms,
          COUNT() AS observations
        FROM {network}.fct_block_data_column_sidecar_first_seen_by_node FINAL
        WHERE slot_start_date_time >= now() - INTERVAL 1 HOUR
        GROUP BY country
        ORDER BY observations DESC
        LIMIT 20

    - name: Slots with data column availability issues
      description: Find slots where any column had less than 100% availability.
      cluster: xatu-cbt
      query: |
        SELECT
          slot,
          COUNT() AS columns_measured,
          countIf(availability_pct < 100) AS columns_with_issues,
          MIN(availability_pct) AS min_availability_pct,
          AVG(availability_pct) AS avg_availability_pct,
          SUM(failure_count) AS total_failures
        FROM {network}.fct_data_column_availability_by_slot FINAL
        WHERE slot_start_date_time >= now() - INTERVAL 1 HOUR
        GROUP BY slot
        HAVING columns_with_issues > 0
        ORDER BY columns_with_issues DESC, slot DESC

    - name: Data column response time distribution
      description: Response time percentiles for data column probes by column index.
      cluster: xatu-cbt
      query: |
        SELECT
          column_index,
          AVG(min_response_time_ms) AS avg_min_response_ms,
          AVG(p50_response_time_ms) AS avg_p50_response_ms,
          AVG(p95_response_time_ms) AS avg_p95_response_ms,
          AVG(p99_response_time_ms) AS avg_p99_response_ms,
          MAX(max_response_time_ms) AS max_response_ms
        FROM {network}.fct_data_column_availability_by_slot FINAL
        WHERE slot_start_date_time >= now() - INTERVAL 1 HOUR
        GROUP BY column_index
        ORDER BY column_index

    - name: Node custody count per epoch
      description: Calculate how many columns each node is responsible for per epoch. Identifies supernodes (128 custody) vs regular nodes.
      cluster: xatu-cbt
      query: |
        SELECT
          node_id,
          meta_consensus_implementation AS client,
          epoch,
          COUNT(DISTINCT column_index) AS custody_count,
          CASE
            WHEN COUNT(DISTINCT column_index) >= 128 THEN 'supernode'
            WHEN COUNT(DISTINCT column_index) >= 64 THEN 'high_custody'
            ELSE 'normal'
          END AS node_type
        FROM {network}.fct_block_data_column_sidecar_first_seen_by_node FINAL
        WHERE slot_start_date_time >= now() - INTERVAL 1 DAY
        GROUP BY node_id, meta_consensus_implementation, epoch
        ORDER BY custody_count DESC
        LIMIT 100

    - name: Column spread per slot
      description: Measure time spread between first and last column received per slot per node. High spread indicates slow column acquisition.
      cluster: xatu-cbt
      query: |
        SELECT
          slot,
          node_id,
          meta_consensus_implementation AS client,
          MIN(seen_slot_start_diff) AS first_column_ms,
          MAX(seen_slot_start_diff) AS last_column_ms,
          MAX(seen_slot_start_diff) - MIN(seen_slot_start_diff) AS spread_ms,
          COUNT(DISTINCT column_index) AS columns_received
        FROM {network}.fct_block_data_column_sidecar_first_seen_by_node FINAL
        WHERE slot_start_date_time >= now() - INTERVAL 1 HOUR
        GROUP BY slot, node_id, meta_consensus_implementation
        HAVING columns_received > 1
        ORDER BY spread_ms DESC
        LIMIT 100

engine_api:
  name: Engine API (CL-EL Communication)
  description: Queries for analyzing consensus-execution layer communication timing and performance
  examples:
    - name: Engine newPayload duration by slot
      description: Get newPayload execution times per slot.
      cluster: xatu-cbt
      query: |
        SELECT
          slot,
          block_number,
          gas_used,
          tx_count,
          blob_count,
          observation_count,
          avg_duration_ms,
          median_duration_ms,
          p95_duration_ms,
          max_duration_ms
        FROM {network}.fct_engine_new_payload_by_slot FINAL
        WHERE slot_start_date_time >= now() - INTERVAL 1 HOUR
        ORDER BY slot DESC
        LIMIT 100

    - name: Engine newPayload by execution client
      description: Compare newPayload performance across execution layer clients.
      cluster: xatu-cbt
      query: |
        SELECT
          meta_execution_implementation AS el_client,
          COUNT() AS slots,
          AVG(avg_duration_ms) AS avg_duration_ms,
          AVG(median_duration_ms) AS median_duration_ms,
          AVG(p95_duration_ms) AS p95_duration_ms,
          MAX(max_duration_ms) AS max_duration_ms
        FROM {network}.fct_engine_new_payload_by_el_client FINAL
        WHERE slot_start_date_time >= now() - INTERVAL 1 HOUR
        GROUP BY el_client
        ORDER BY avg_duration_ms

    - name: Engine newPayload hourly trend by client
      description: Hourly trend of newPayload duration per execution client.
      cluster: xatu-cbt
      query: |
        SELECT
          toStartOfHour(slot_start_date_time) AS hour,
          meta_execution_implementation AS el_client,
          COUNT() AS observations,
          AVG(avg_duration_ms) AS avg_duration_ms,
          AVG(p95_duration_ms) AS p95_duration_ms
        FROM {network}.fct_engine_new_payload_by_el_client FINAL
        WHERE slot_start_date_time >= now() - INTERVAL 24 HOUR
        GROUP BY hour, el_client
        ORDER BY hour DESC, el_client

    - name: Slowest newPayload executions
      description: Find slots with the slowest newPayload execution times.
      cluster: xatu-cbt
      query: |
        SELECT
          slot,
          block_number,
          gas_used,
          tx_count,
          blob_count,
          max_duration_ms,
          p95_duration_ms,
          observation_count
        FROM {network}.fct_engine_new_payload_by_slot FINAL
        WHERE slot_start_date_time >= now() - INTERVAL 1 HOUR
        ORDER BY max_duration_ms DESC
        LIMIT 20

    - name: Engine getBlobs by slot
      description: Get getBlobs call statistics per slot.
      cluster: xatu-cbt
      query: |
        SELECT
          slot,
          status,
          observation_count,
          max_requested_count,
          avg_returned_count,
          full_return_pct,
          avg_duration_ms,
          p95_duration_ms,
          max_duration_ms
        FROM {network}.fct_engine_get_blobs_by_slot FINAL
        WHERE slot_start_date_time >= now() - INTERVAL 1 HOUR
        ORDER BY slot DESC
        LIMIT 100

    - name: Engine getBlobs by execution client
      description: Compare getBlobs performance across execution layer clients.
      cluster: xatu-cbt
      query: |
        SELECT
          meta_execution_implementation AS el_client,
          COUNT() AS slots,
          AVG(avg_duration_ms) AS avg_duration_ms,
          AVG(median_duration_ms) AS median_duration_ms,
          AVG(p95_duration_ms) AS p95_duration_ms,
          MAX(max_duration_ms) AS max_duration_ms,
          AVG(avg_returned_count) AS avg_blobs_returned
        FROM {network}.fct_engine_get_blobs_by_el_client FINAL
        WHERE slot_start_date_time >= now() - INTERVAL 1 HOUR
        GROUP BY el_client
        ORDER BY avg_duration_ms

    - name: Engine API duration percentile distribution
      description: Distribution of newPayload durations in 50ms buckets.
      cluster: xatu-cbt
      query: |
        SELECT
          duration_bucket_ms,
          SUM(observation_count) AS total_observations,
          SUM(observation_count) * 100.0 / SUM(SUM(observation_count)) OVER () AS percentage
        FROM {network}.fct_engine_new_payload_duration_chunked_50ms FINAL
        WHERE slot_start_date_time >= now() - INTERVAL 1 HOUR
        GROUP BY duration_bucket_ms
        ORDER BY duration_bucket_ms

    - name: Correlation between gas usage and newPayload duration
      description: Analyze how block gas usage affects newPayload execution time.
      cluster: xatu-cbt
      query: |
        SELECT
          intDiv(gas_used, 1000000) AS gas_millions,
          COUNT() AS slot_count,
          AVG(avg_duration_ms) AS avg_duration_ms,
          AVG(p95_duration_ms) AS p95_duration_ms,
          AVG(tx_count) AS avg_tx_count
        FROM {network}.fct_engine_new_payload_by_slot FINAL
        WHERE slot_start_date_time >= now() - INTERVAL 6 HOUR
          AND gas_used > 0
        GROUP BY gas_millions
        ORDER BY gas_millions

    - name: Engine API performance by blob count
      description: Analyze how blob count affects newPayload and getBlobs duration.
      cluster: xatu-cbt
      query: |
        SELECT
          blob_count,
          COUNT() AS slot_count,
          AVG(avg_duration_ms) AS avg_newpayload_ms,
          AVG(p95_duration_ms) AS p95_newpayload_ms
        FROM {network}.fct_engine_new_payload_by_slot FINAL
        WHERE slot_start_date_time >= now() - INTERVAL 6 HOUR
        GROUP BY blob_count
        ORDER BY blob_count

execution_state:
  name: Execution State Growth
  description: Queries for analyzing Ethereum state size and storage slot usage
  examples:
    - name: Daily state size growth
      description: Track daily growth of Ethereum state size.
      cluster: xatu-cbt
      query: |
        SELECT
          day_start_date,
          formatReadableSize(total_bytes) AS total_size,
          accounts,
          storages,
          formatReadableSize(account_bytes) AS account_size,
          formatReadableSize(storage_bytes) AS storage_size,
          formatReadableSize(contract_code_bytes) AS code_size
        FROM {network}.fct_execution_state_size_daily FINAL
        ORDER BY day_start_date DESC
        LIMIT 30

    - name: Hourly state size growth
      description: Track hourly growth of Ethereum state size.
      cluster: xatu-cbt
      query: |
        SELECT
          hour_start_date_time,
          formatReadableSize(total_bytes) AS total_size,
          accounts,
          storages,
          formatReadableSize(storage_bytes) AS storage_size
        FROM {network}.fct_execution_state_size_hourly FINAL
        ORDER BY hour_start_date_time DESC
        LIMIT 48

    - name: State growth rate
      description: Calculate daily state growth rate over the past week.
      cluster: xatu-cbt
      query: |
        SELECT
          day_start_date,
          total_bytes,
          total_bytes - lagInFrame(total_bytes) OVER (ORDER BY day_start_date) AS bytes_growth,
          accounts - lagInFrame(accounts) OVER (ORDER BY day_start_date) AS accounts_growth,
          storages - lagInFrame(storages) OVER (ORDER BY day_start_date) AS storages_growth
        FROM {network}.fct_execution_state_size_daily FINAL
        ORDER BY day_start_date DESC
        LIMIT 8


    - name: State composition breakdown
      description: Breakdown of state size by component type.
      cluster: xatu-cbt
      query: |
        SELECT
          day_start_date,
          formatReadableSize(account_bytes) AS accounts,
          formatReadableSize(account_trienode_bytes) AS account_tries,
          formatReadableSize(contract_code_bytes) AS contract_code,
          formatReadableSize(storage_bytes) AS storage,
          formatReadableSize(storage_trienode_bytes) AS storage_tries,
          formatReadableSize(total_bytes) AS total
        FROM {network}.fct_execution_state_size_daily FINAL
        ORDER BY day_start_date DESC
        LIMIT 1


prepared_blocks:
  name: Prepared Blocks (Local Block Building)
  description: Queries for analyzing locally prepared block performance and characteristics
  examples:
    - name: Recent prepared blocks
      description: Get details of recently prepared blocks by local nodes.
      cluster: xatu-cbt
      query: |
        SELECT
          slot,
          slot_start_date_time,
          meta_consensus_implementation AS cl_client,
          block_version,
          execution_payload_block_number AS block_number,
          execution_payload_gas_used AS gas_used,
          execution_payload_transactions_count AS tx_count,
          block_total_bytes,
          execution_payload_value / 1e18 AS block_value_eth
        FROM {network}.fct_prepared_block FINAL
        WHERE slot_start_date_time >= now() - INTERVAL 1 HOUR
        ORDER BY slot DESC
        LIMIT 50

    - name: Prepared blocks by consensus client
      description: Compare block building across consensus clients.
      cluster: xatu-cbt
      query: |
        SELECT
          meta_consensus_implementation AS cl_client,
          COUNT() AS blocks_prepared,
          AVG(execution_payload_gas_used) AS avg_gas_used,
          AVG(execution_payload_transactions_count) AS avg_tx_count,
          AVG(block_total_bytes) AS avg_block_bytes,
          AVG(execution_payload_value) / 1e18 AS avg_value_eth
        FROM {network}.fct_prepared_block FINAL
        WHERE slot_start_date_time >= now() - INTERVAL 6 HOUR
        GROUP BY cl_client
        ORDER BY blocks_prepared DESC

    - name: Prepared blocks by country
      description: Geographic distribution of block preparation.
      cluster: xatu-cbt
      query: |
        SELECT
          meta_client_geo_country AS country,
          COUNT() AS blocks_prepared,
          AVG(execution_payload_gas_used) AS avg_gas_used,
          AVG(execution_payload_transactions_count) AS avg_tx_count
        FROM {network}.fct_prepared_block FINAL
        WHERE slot_start_date_time >= now() - INTERVAL 6 HOUR
        GROUP BY country
        ORDER BY blocks_prepared DESC
        LIMIT 20

    - name: Block size distribution
      description: Distribution of prepared block sizes.
      cluster: xatu-cbt
      query: |
        SELECT
          intDiv(block_total_bytes, 10000) * 10 AS size_kb_bucket,
          COUNT() AS block_count,
          AVG(execution_payload_transactions_count) AS avg_tx_count,
          AVG(execution_payload_gas_used) AS avg_gas_used
        FROM {network}.fct_prepared_block FINAL
        WHERE slot_start_date_time >= now() - INTERVAL 6 HOUR
          AND block_total_bytes IS NOT NULL
        GROUP BY size_kb_bucket
        ORDER BY size_kb_bucket

    - name: High value prepared blocks
      description: Find prepared blocks with highest execution payload values.
      cluster: xatu-cbt
      query: |
        SELECT
          slot,
          meta_consensus_implementation AS cl_client,
          execution_payload_block_number AS block_number,
          execution_payload_value / 1e18 AS value_eth,
          execution_payload_gas_used AS gas_used,
          execution_payload_transactions_count AS tx_count
        FROM {network}.fct_prepared_block FINAL
        WHERE slot_start_date_time >= now() - INTERVAL 6 HOUR
          AND execution_payload_value > 0
        ORDER BY execution_payload_value DESC
        LIMIT 20

    - name: Block version distribution
      description: Distribution of block versions (deneb, electra, etc).
      cluster: xatu-cbt
      query: |
        SELECT
          block_version,
          COUNT() AS block_count,
          AVG(block_total_bytes) AS avg_block_bytes,
          AVG(execution_payload_transactions_count) AS avg_tx_count
        FROM {network}.fct_prepared_block FINAL
        WHERE slot_start_date_time >= now() - INTERVAL 24 HOUR
        GROUP BY block_version
        ORDER BY block_count DESC

node_metadata:
  name: Node Metadata & Diversity
  description: Queries for analyzing sentry node distribution and client diversity
  examples:
    - name: Active nodes summary
      description: Get summary of active sentry nodes in the last 24 hours.
      cluster: xatu-cbt
      query: |
        SELECT
          COUNT() AS total_nodes,
          countDistinct(meta_consensus_implementation) AS unique_cl_clients,
          countDistinct(meta_client_geo_country) AS unique_countries,
          countDistinct(meta_client_geo_autonomous_system_organization) AS unique_asns
        FROM {network}.fct_node_active_last_24h FINAL

    - name: Nodes by consensus client
      description: Distribution of active nodes by consensus client.
      cluster: xatu-cbt
      query: |
        SELECT
          meta_consensus_implementation AS cl_client,
          COUNT() AS node_count,
          COUNT() * 100.0 / SUM(COUNT()) OVER () AS percentage
        FROM {network}.fct_node_active_last_24h FINAL
        GROUP BY cl_client
        ORDER BY node_count DESC

    - name: Nodes by country
      description: Geographic distribution of active sentry nodes.
      cluster: xatu-cbt
      query: |
        SELECT
          meta_client_geo_country AS country,
          meta_client_geo_country_code AS country_code,
          COUNT() AS node_count,
          COUNT() * 100.0 / SUM(COUNT()) OVER () AS percentage
        FROM {network}.fct_node_active_last_24h FINAL
        GROUP BY country, country_code
        ORDER BY node_count DESC
        LIMIT 20

    - name: Nodes by ASN
      description: Distribution of nodes by autonomous system (hosting provider).
      cluster: xatu-cbt
      query: |
        SELECT
          meta_client_geo_autonomous_system_organization AS asn_org,
          meta_client_geo_autonomous_system_number AS asn,
          COUNT() AS node_count
        FROM {network}.fct_node_active_last_24h FINAL
        WHERE meta_client_geo_autonomous_system_organization IS NOT NULL
        GROUP BY asn_org, asn
        ORDER BY node_count DESC
        LIMIT 20

    - name: Client version distribution
      description: Distribution of consensus client versions.
      cluster: xatu-cbt
      query: |
        SELECT
          meta_consensus_implementation AS cl_client,
          meta_consensus_version AS version,
          COUNT() AS node_count
        FROM {network}.fct_node_active_last_24h FINAL
        GROUP BY cl_client, version
        ORDER BY cl_client, node_count DESC

    - name: Node classification breakdown
      description: Breakdown of nodes by classification type.
      cluster: xatu-cbt
      query: |
        SELECT
          classification,
          COUNT() AS node_count,
          countDistinct(meta_consensus_implementation) AS unique_clients,
          countDistinct(meta_client_geo_country) AS unique_countries
        FROM {network}.fct_node_active_last_24h FINAL
        GROUP BY classification
        ORDER BY node_count DESC

    - name: Nodes by continent
      description: Distribution of nodes by continent.
      cluster: xatu-cbt
      query: |
        SELECT
          meta_client_geo_continent_code AS continent,
          COUNT() AS node_count,
          countDistinct(meta_client_geo_country) AS countries,
          countDistinct(meta_consensus_implementation) AS cl_clients
        FROM {network}.fct_node_active_last_24h FINAL
        GROUP BY continent
        ORDER BY node_count DESC

mev_bids:
  name: MEV Bid Analysis
  description: Queries for analyzing MEV bid patterns by builder and relay
  examples:
    - name: Bids per slot by builder
      description: Total bids submitted per slot by each builder.
      cluster: xatu-cbt
      query: |
        SELECT
          slot,
          builder_pubkey,
          bid_total
        FROM {network}.fct_mev_bid_count_by_builder FINAL
        WHERE slot_start_date_time >= now() - INTERVAL 1 HOUR
        ORDER BY slot DESC, bid_total DESC
        LIMIT 100

    - name: Top builders by total bids
      description: Builders ranked by total bid count.
      cluster: xatu-cbt
      query: |
        SELECT
          builder_pubkey,
          SUM(bid_total) AS total_bids,
          COUNT() AS slots_with_bids,
          AVG(bid_total) AS avg_bids_per_slot
        FROM {network}.fct_mev_bid_count_by_builder FINAL
        WHERE slot_start_date_time >= now() - INTERVAL 1 HOUR
        GROUP BY builder_pubkey
        ORDER BY total_bids DESC
        LIMIT 20

    - name: Bids per slot by relay
      description: Total bids received per slot by each relay.
      cluster: xatu-cbt
      query: |
        SELECT
          slot,
          relay_name,
          bid_total
        FROM {network}.fct_mev_bid_count_by_relay FINAL
        WHERE slot_start_date_time >= now() - INTERVAL 1 HOUR
        ORDER BY slot DESC, bid_total DESC
        LIMIT 100

    - name: Relay bid volume comparison
      description: Compare bid volumes across relays.
      cluster: xatu-cbt
      query: |
        SELECT
          relay_name,
          SUM(bid_total) AS total_bids,
          COUNT() AS slots_with_bids,
          AVG(bid_total) AS avg_bids_per_slot,
          MAX(bid_total) AS max_bids_in_slot
        FROM {network}.fct_mev_bid_count_by_relay FINAL
        WHERE slot_start_date_time >= now() - INTERVAL 1 HOUR
        GROUP BY relay_name
        ORDER BY total_bids DESC

    - name: Highest value bids by timing
      description: Track when highest value bids arrive relative to slot start.
      cluster: xatu-cbt
      query: |
        SELECT
          slot,
          chunk_slot_start_diff AS timing_ms,
          builder_pubkey,
          value / 1e18 AS value_eth,
          relay_names,
          block_hash
        FROM {network}.fct_mev_bid_highest_value_by_builder_chunked_50ms FINAL
        WHERE slot_start_date_time >= now() - INTERVAL 1 HOUR
        ORDER BY slot DESC, value DESC
        LIMIT 100

    - name: Bid value progression within slot
      description: How bid values increase as slot deadline approaches.
      cluster: xatu-cbt
      query: |
        SELECT
          chunk_slot_start_diff AS timing_ms,
          COUNT() AS bid_count,
          AVG(value) / 1e18 AS avg_value_eth,
          MAX(value) / 1e18 AS max_value_eth
        FROM {network}.fct_mev_bid_highest_value_by_builder_chunked_50ms FINAL
        WHERE slot_start_date_time >= now() - INTERVAL 1 HOUR
        GROUP BY timing_ms
        ORDER BY timing_ms

    - name: Builder bid timing patterns
      description: When different builders typically submit their highest bids.
      cluster: xatu-cbt
      query: |
        SELECT
          builder_pubkey,
          AVG(chunk_slot_start_diff) AS avg_timing_ms,
          MIN(chunk_slot_start_diff) AS earliest_timing_ms,
          MAX(chunk_slot_start_diff) AS latest_timing_ms,
          COUNT() AS bid_count,
          AVG(value) / 1e18 AS avg_value_eth
        FROM {network}.fct_mev_bid_highest_value_by_builder_chunked_50ms FINAL
        WHERE slot_start_date_time >= now() - INTERVAL 1 HOUR
        GROUP BY builder_pubkey
        ORDER BY avg_value_eth DESC
        LIMIT 20

attestation_propagation:
  name: Attestation Propagation
  description: Queries for analyzing attestation arrival timing and distribution
  examples:
    - name: Attestation arrival distribution
      description: Distribution of attestation arrival times in 50ms buckets.
      cluster: xatu-cbt
      query: |
        SELECT
          chunk_slot_start_diff AS timing_ms,
          SUM(attestation_count) AS total_attestations,
          SUM(attestation_count) * 100.0 / SUM(SUM(attestation_count)) OVER () AS percentage
        FROM {network}.fct_attestation_first_seen_chunked_50ms FINAL
        WHERE slot_start_date_time >= now() - INTERVAL 1 HOUR
        GROUP BY timing_ms
        ORDER BY timing_ms

    - name: Attestation arrival by slot
      description: Attestation timing statistics per slot.
      cluster: xatu-cbt
      query: |
        SELECT
          slot,
          SUM(attestation_count) AS total_attestations,
          MIN(chunk_slot_start_diff) AS earliest_ms,
          MAX(chunk_slot_start_diff) AS latest_ms
        FROM {network}.fct_attestation_first_seen_chunked_50ms FINAL
        WHERE slot_start_date_time >= now() - INTERVAL 1 HOUR
        GROUP BY slot
        ORDER BY slot DESC
        LIMIT 50

    - name: Attestation observations by node
      description: How each node observes attestations.
      cluster: xatu-cbt
      query: |
        SELECT
          meta_consensus_implementation AS cl_client,
          meta_client_geo_country AS country,
          SUM(attestation_count) AS total_attestations,
          AVG(avg_seen_slot_start_diff) AS avg_arrival_ms,
          AVG(min_seen_slot_start_diff) AS avg_earliest_ms
        FROM {network}.fct_attestation_observation_by_node FINAL
        WHERE slot_start_date_time >= now() - INTERVAL 1 HOUR
        GROUP BY cl_client, country
        ORDER BY total_attestations DESC
        LIMIT 30

    - name: Attestation propagation by consensus client
      description: Compare attestation arrival times across consensus clients.
      cluster: xatu-cbt
      query: |
        SELECT
          meta_consensus_implementation AS cl_client,
          COUNT() AS observation_count,
          AVG(avg_seen_slot_start_diff) AS avg_arrival_ms,
          AVG(median_seen_slot_start_diff) AS median_arrival_ms,
          AVG(min_seen_slot_start_diff) AS avg_earliest_ms
        FROM {network}.fct_attestation_observation_by_node FINAL
        WHERE slot_start_date_time >= now() - INTERVAL 1 HOUR
        GROUP BY cl_client
        ORDER BY avg_arrival_ms

    - name: Attestation propagation by country
      description: Compare attestation arrival times across countries.
      cluster: xatu-cbt
      query: |
        SELECT
          meta_client_geo_country AS country,
          COUNT() AS observation_count,
          AVG(avg_seen_slot_start_diff) AS avg_arrival_ms,
          AVG(min_seen_slot_start_diff) AS avg_earliest_ms,
          SUM(attestation_count) AS total_attestations
        FROM {network}.fct_attestation_observation_by_node FINAL
        WHERE slot_start_date_time >= now() - INTERVAL 1 HOUR
        GROUP BY country
        ORDER BY total_attestations DESC
        LIMIT 20

    - name: Late attestation analysis
      description: Find slots with late-arriving attestations.
      cluster: xatu-cbt
      query: |
        SELECT
          slot,
          SUM(attestation_count) AS late_attestations,
          MIN(chunk_slot_start_diff) AS earliest_late_ms
        FROM {network}.fct_attestation_first_seen_chunked_50ms FINAL
        WHERE slot_start_date_time >= now() - INTERVAL 1 HOUR
          AND chunk_slot_start_diff >= 4000
        GROUP BY slot
        ORDER BY late_attestations DESC
        LIMIT 20

head_tracking:
  name: Head Tracking (Fork Choice)
  description: Queries for analyzing when nodes adopt new chain heads
  examples:
    - name: Head adoption timing by slot
      description: When nodes adopt new heads relative to slot start.
      cluster: xatu-cbt
      query: |
        SELECT
          slot,
          MIN(seen_slot_start_diff) AS earliest_adoption_ms,
          AVG(seen_slot_start_diff) AS avg_adoption_ms,
          MAX(seen_slot_start_diff) AS latest_adoption_ms,
          COUNT() AS node_count
        FROM {network}.fct_head_first_seen_by_node FINAL
        WHERE slot_start_date_time >= now() - INTERVAL 1 HOUR
        GROUP BY slot
        ORDER BY slot DESC
        LIMIT 50

    - name: Head adoption by consensus client
      description: Compare head adoption timing across consensus clients.
      cluster: xatu-cbt
      query: |
        SELECT
          meta_consensus_implementation AS cl_client,
          AVG(seen_slot_start_diff) AS avg_adoption_ms,
          quantile(0.50)(seen_slot_start_diff) AS p50_adoption_ms,
          quantile(0.95)(seen_slot_start_diff) AS p95_adoption_ms,
          COUNT() AS observations
        FROM {network}.fct_head_first_seen_by_node FINAL
        WHERE slot_start_date_time >= now() - INTERVAL 1 HOUR
        GROUP BY cl_client
        ORDER BY avg_adoption_ms

    - name: Head adoption by country
      description: Compare head adoption timing across countries.
      cluster: xatu-cbt
      query: |
        SELECT
          meta_client_geo_country AS country,
          AVG(seen_slot_start_diff) AS avg_adoption_ms,
          quantile(0.50)(seen_slot_start_diff) AS p50_adoption_ms,
          quantile(0.95)(seen_slot_start_diff) AS p95_adoption_ms,
          COUNT() AS observations
        FROM {network}.fct_head_first_seen_by_node FINAL
        WHERE slot_start_date_time >= now() - INTERVAL 1 HOUR
        GROUP BY country
        ORDER BY observations DESC
        LIMIT 20

    - name: Slow head adoption events
      description: Find slots where head adoption was unusually slow.
      cluster: xatu-cbt
      query: |
        SELECT
          slot,
          block_root,
          AVG(seen_slot_start_diff) AS avg_adoption_ms,
          MAX(seen_slot_start_diff) AS max_adoption_ms,
          COUNT() AS nodes_observed
        FROM {network}.fct_head_first_seen_by_node FINAL
        WHERE slot_start_date_time >= now() - INTERVAL 1 HOUR
        GROUP BY slot, block_root
        HAVING avg_adoption_ms > 2000
        ORDER BY avg_adoption_ms DESC
        LIMIT 20

    - name: Head adoption by source
      description: Compare head adoption timing by event source.
      cluster: xatu-cbt
      query: |
        SELECT
          source,
          AVG(seen_slot_start_diff) AS avg_adoption_ms,
          quantile(0.50)(seen_slot_start_diff) AS p50_adoption_ms,
          COUNT() AS observations
        FROM {network}.fct_head_first_seen_by_node FINAL
        WHERE slot_start_date_time >= now() - INTERVAL 1 HOUR
        GROUP BY source
        ORDER BY observations DESC

    - name: Head adoption variance by slot
      description: Measure how much head adoption timing varies across nodes per slot.
      cluster: xatu-cbt
      query: |
        SELECT
          slot,
          AVG(seen_slot_start_diff) AS avg_adoption_ms,
          stddevPop(seen_slot_start_diff) AS stddev_adoption_ms,
          MAX(seen_slot_start_diff) - MIN(seen_slot_start_diff) AS adoption_spread_ms,
          COUNT() AS nodes_observed
        FROM {network}.fct_head_first_seen_by_node FINAL
        WHERE slot_start_date_time >= now() - INTERVAL 1 HOUR
        GROUP BY slot
        ORDER BY adoption_spread_ms DESC
        LIMIT 20

    - name: Head adoption by ASN
      description: Compare head adoption timing across hosting providers.
      cluster: xatu-cbt
      query: |
        SELECT
          meta_client_geo_autonomous_system_organization AS asn_org,
          AVG(seen_slot_start_diff) AS avg_adoption_ms,
          quantile(0.95)(seen_slot_start_diff) AS p95_adoption_ms,
          COUNT() AS observations
        FROM {network}.fct_head_first_seen_by_node FINAL
        WHERE slot_start_date_time >= now() - INTERVAL 1 HOUR
          AND meta_client_geo_autonomous_system_organization IS NOT NULL
        GROUP BY asn_org
        ORDER BY observations DESC
        LIMIT 20

libp2p_gossipsub:
  name: libp2p GossipSub
  description: Queries for analyzing libp2p gossipsub message propagation and peer behavior
  examples:
    - name: Block gossip propagation timing
      description: Block message propagation times across the gossipsub network.
      cluster: xatu
      query: |
        SELECT
          slot,
          block,
          proposer_index,
          MIN(propagation_slot_start_diff) AS first_seen_ms,
          AVG(propagation_slot_start_diff) AS avg_propagation_ms,
          MAX(propagation_slot_start_diff) AS last_seen_ms,
          COUNT() AS message_count,
          countDistinct(peer_id_unique_key) AS unique_peers
        FROM libp2p_gossipsub_beacon_block
        WHERE meta_network_name = 'mainnet'
          AND slot_start_date_time >= now() - INTERVAL 1 HOUR
        GROUP BY slot, block, proposer_index
        ORDER BY slot DESC
        LIMIT 50

    - name: Block gossip by consensus client
      description: Compare block propagation across consensus client implementations.
      cluster: xatu
      query: |
        SELECT
          meta_client_implementation AS client,
          AVG(propagation_slot_start_diff) AS avg_propagation_ms,
          quantile(0.50)(propagation_slot_start_diff) AS p50_ms,
          quantile(0.95)(propagation_slot_start_diff) AS p95_ms,
          COUNT() AS messages,
          countDistinct(peer_id_unique_key) AS unique_peers
        FROM libp2p_gossipsub_beacon_block
        WHERE meta_network_name = 'mainnet'
          AND slot_start_date_time >= now() - INTERVAL 1 HOUR
        GROUP BY client
        ORDER BY avg_propagation_ms

    - name: Block gossip by country
      description: Geographic distribution of block propagation timing.
      cluster: xatu
      query: |
        SELECT
          meta_client_geo_country AS country,
          AVG(propagation_slot_start_diff) AS avg_propagation_ms,
          quantile(0.95)(propagation_slot_start_diff) AS p95_ms,
          COUNT() AS messages,
          countDistinct(peer_id_unique_key) AS unique_peers
        FROM libp2p_gossipsub_beacon_block
        WHERE meta_network_name = 'mainnet'
          AND slot_start_date_time >= now() - INTERVAL 1 HOUR
        GROUP BY country
        ORDER BY messages DESC
        LIMIT 20

    - name: Attestation gossip propagation
      description: Attestation propagation times per slot.
      cluster: xatu
      query: |
        SELECT
          slot,
          MIN(propagation_slot_start_diff) AS first_seen_ms,
          AVG(propagation_slot_start_diff) AS avg_propagation_ms,
          quantile(0.95)(propagation_slot_start_diff) AS p95_ms,
          COUNT() AS message_count,
          countDistinct(peer_id_unique_key) AS unique_peers
        FROM libp2p_gossipsub_beacon_attestation
        WHERE meta_network_name = 'mainnet'
          AND slot_start_date_time >= now() - INTERVAL 1 HOUR
        GROUP BY slot
        ORDER BY slot DESC
        LIMIT 50

    - name: Attestation gossip by committee
      description: Attestation propagation breakdown by committee index.
      cluster: xatu
      query: |
        SELECT
          committee_index,
          AVG(propagation_slot_start_diff) AS avg_propagation_ms,
          quantile(0.95)(propagation_slot_start_diff) AS p95_ms,
          COUNT() AS message_count
        FROM libp2p_gossipsub_beacon_attestation
        WHERE meta_network_name = 'mainnet'
          AND slot_start_date_time >= now() - INTERVAL 1 HOUR
        GROUP BY committee_index
        ORDER BY committee_index

    - name: Blob sidecar gossip propagation
      description: Blob sidecar propagation times by slot and blob index.
      cluster: xatu
      query: |
        SELECT
          slot,
          blob_index,
          MIN(propagation_slot_start_diff) AS first_seen_ms,
          AVG(propagation_slot_start_diff) AS avg_propagation_ms,
          MAX(propagation_slot_start_diff) AS last_seen_ms,
          COUNT() AS message_count,
          AVG(message_size) AS avg_message_size
        FROM libp2p_gossipsub_blob_sidecar
        WHERE meta_network_name = 'mainnet'
          AND slot_start_date_time >= now() - INTERVAL 1 HOUR
        GROUP BY slot, blob_index
        ORDER BY slot DESC, blob_index
        LIMIT 100

    - name: Data column sidecar gossip propagation
      description: Data column sidecar (PeerDAS) propagation times.
      cluster: xatu
      query: |
        SELECT
          slot,
          column_index,
          MIN(propagation_slot_start_diff) AS first_seen_ms,
          AVG(propagation_slot_start_diff) AS avg_propagation_ms,
          MAX(propagation_slot_start_diff) AS last_seen_ms,
          COUNT() AS message_count,
          AVG(message_size) AS avg_message_size
        FROM libp2p_gossipsub_data_column_sidecar
        WHERE meta_network_name = 'mainnet'
          AND slot_start_date_time >= now() - INTERVAL 1 HOUR
        GROUP BY slot, column_index
        ORDER BY slot DESC, column_index
        LIMIT 100

    - name: Message size by topic
      description: Average message sizes across different gossipsub topics.
      cluster: xatu
      query: |
        SELECT
          topic_name,
          AVG(message_size) AS avg_size_bytes,
          MIN(message_size) AS min_size,
          MAX(message_size) AS max_size,
          COUNT() AS message_count
        FROM libp2p_gossipsub_beacon_block
        WHERE meta_network_name = 'mainnet'
          AND slot_start_date_time >= now() - INTERVAL 1 HOUR
        GROUP BY topic_name
        ORDER BY message_count DESC

libp2p_peers:
  name: libp2p Peer Connections
  description: Queries for analyzing libp2p peer connections and network topology
  examples:
    - name: Peer connections by client
      description: Distribution of connected peers by client implementation.
      cluster: xatu
      query: |
        SELECT
          remote_agent_implementation AS peer_client,
          COUNT() AS connection_count,
          countDistinct(remote_peer_id_unique_key) AS unique_peers
        FROM libp2p_connected
        WHERE meta_network_name = 'mainnet'
          AND event_date_time >= now() - INTERVAL 1 HOUR
        GROUP BY peer_client
        ORDER BY connection_count DESC

    - name: Peer connections by country
      description: Geographic distribution of peer connections.
      cluster: xatu
      query: |
        SELECT
          remote_geo_country AS country,
          COUNT() AS connection_count,
          countDistinct(remote_peer_id_unique_key) AS unique_peers
        FROM libp2p_connected
        WHERE meta_network_name = 'mainnet'
          AND event_date_time >= now() - INTERVAL 1 HOUR
        GROUP BY country
        ORDER BY connection_count DESC
        LIMIT 20

    - name: Peer connections by ASN
      description: Distribution of peer connections by hosting provider.
      cluster: xatu
      query: |
        SELECT
          remote_geo_autonomous_system_organization AS asn_org,
          COUNT() AS connection_count,
          countDistinct(remote_peer_id_unique_key) AS unique_peers
        FROM libp2p_connected
        WHERE meta_network_name = 'mainnet'
          AND event_date_time >= now() - INTERVAL 1 HOUR
          AND remote_geo_autonomous_system_organization IS NOT NULL
        GROUP BY asn_org
        ORDER BY connection_count DESC
        LIMIT 20

    - name: Connection direction breakdown
      description: Inbound vs outbound peer connections.
      cluster: xatu
      query: |
        SELECT
          direction,
          COUNT() AS connection_count,
          countDistinct(remote_peer_id_unique_key) AS unique_peers
        FROM libp2p_connected
        WHERE meta_network_name = 'mainnet'
          AND event_date_time >= now() - INTERVAL 1 HOUR
        GROUP BY direction

    - name: Client version distribution
      description: Distribution of peer client versions.
      cluster: xatu
      query: |
        SELECT
          remote_agent_implementation AS client,
          remote_agent_version_major AS major_version,
          COUNT() AS connection_count,
          countDistinct(remote_peer_id_unique_key) AS unique_peers
        FROM libp2p_connected
        WHERE meta_network_name = 'mainnet'
          AND event_date_time >= now() - INTERVAL 1 HOUR
        GROUP BY client, major_version
        ORDER BY client, connection_count DESC

    - name: Disconnection events
      description: Recent peer disconnection events.
      cluster: xatu
      query: |
        SELECT
          remote_agent_implementation AS peer_client,
          remote_geo_country AS country,
          direction,
          COUNT() AS disconnect_count,
          countDistinct(remote_peer_id_unique_key) AS unique_peers
        FROM libp2p_disconnected
        WHERE meta_network_name = 'mainnet'
          AND event_date_time >= now() - INTERVAL 1 HOUR
        GROUP BY peer_client, country, direction
        ORDER BY disconnect_count DESC
        LIMIT 30

    - name: Connection churn rate
      description: Compare connection vs disconnection rates over time.
      cluster: xatu
      query: |
        SELECT
          toStartOfMinute(event_date_time) AS minute,
          countIf(1) AS connections
        FROM libp2p_connected
        WHERE meta_network_name = 'mainnet'
          AND event_date_time >= now() - INTERVAL 1 HOUR
        GROUP BY minute
        ORDER BY minute DESC

libp2p_messages:
  name: libp2p Message Handling
  description: Queries for analyzing message delivery, rejection, and duplication
  examples:
    - name: Message delivery by topic
      description: Message delivery statistics by gossipsub topic.
      cluster: xatu
      query: |
        SELECT
          topic_name,
          COUNT() AS delivered_count,
          countIf(local_delivery = true) AS local_deliveries,
          AVG(message_size) AS avg_message_size,
          SUM(message_size) AS total_bytes
        FROM libp2p_deliver_message
        WHERE meta_network_name = 'mainnet'
          AND event_date_time >= now() - INTERVAL 1 HOUR
        GROUP BY topic_name
        ORDER BY delivered_count DESC

    - name: Rejected messages by reason
      description: Message rejection reasons and counts.
      cluster: xatu
      query: |
        SELECT
          reason,
          topic_name,
          COUNT() AS reject_count,
          countDistinct(peer_id_unique_key) AS unique_peers
        FROM libp2p_reject_message
        WHERE meta_network_name = 'mainnet'
          AND event_date_time >= now() - INTERVAL 1 HOUR
        GROUP BY reason, topic_name
        ORDER BY reject_count DESC
        LIMIT 30

    - name: Duplicate messages by topic
      description: Duplicate message statistics by gossipsub topic.
      cluster: xatu
      query: |
        SELECT
          topic_name,
          COUNT() AS duplicate_count,
          countDistinct(message_id) AS unique_messages,
          AVG(message_size) AS avg_message_size
        FROM libp2p_duplicate_message
        WHERE meta_network_name = 'mainnet'
          AND event_date_time >= now() - INTERVAL 1 HOUR
        GROUP BY topic_name
        ORDER BY duplicate_count DESC

    - name: Duplication ratio by topic
      description: Calculate message duplication ratio (duplicates vs deliveries).
      cluster: xatu
      query: |
        SELECT
          d.topic_name,
          d.delivered AS delivered,
          dup.duplicates AS duplicates,
          dup.duplicates * 100.0 / (d.delivered + dup.duplicates) AS duplication_pct
        FROM (
          SELECT topic_name, COUNT() AS delivered
          FROM libp2p_deliver_message
          WHERE meta_network_name = 'mainnet'
            AND event_date_time >= now() - INTERVAL 1 HOUR
          GROUP BY topic_name
        ) d
        LEFT JOIN (
          SELECT topic_name, COUNT() AS duplicates
          FROM libp2p_duplicate_message
          WHERE meta_network_name = 'mainnet'
            AND event_date_time >= now() - INTERVAL 1 HOUR
          GROUP BY topic_name
        ) dup ON d.topic_name = dup.topic_name
        ORDER BY duplication_pct DESC

    - name: Topic join/leave activity
      description: Peer topic subscription changes.
      cluster: xatu
      query: |
        SELECT
          topic_name,
          countIf(1) AS joins
        FROM libp2p_join
        WHERE meta_network_name = 'mainnet'
          AND event_date_time >= now() - INTERVAL 1 HOUR
        GROUP BY topic_name
        ORDER BY joins DESC

    - name: Message rejection rate by client
      description: Which clients are rejecting the most messages.
      cluster: xatu
      query: |
        SELECT
          meta_client_implementation AS client,
          COUNT() AS reject_count,
          countDistinct(message_id) AS unique_messages,
          groupArray(10)(reason) AS sample_reasons
        FROM libp2p_reject_message
        WHERE meta_network_name = 'mainnet'
          AND event_date_time >= now() - INTERVAL 1 HOUR
        GROUP BY client
        ORDER BY reject_count DESC
